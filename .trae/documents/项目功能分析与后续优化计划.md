# 项目功能分析与后续优化计划

## 当前功能概览
- 前端：`Next.js 14 + React + Tailwind`，页面在 `app/`；三栏聊天界面与移动端适配
- 后端：`Next.js API Routes`，通过 `Supabase` 读表并代理到 `Dify`
- AI接入：`/api/dify/*` 代理 `Dify API`，支持 SSE 流式回复
- 数据：`users/assistants` 两张表，助手可配置 `dify_api_key/dify_base_url/key_ref`

## 改进目标
- 强化登录与安全：使用哈希密码、完善错误处理
- 优化聊天体验：SSE 稳定性、断线重试、心跳处理
- 配置与扩展：抽离助手预设为可维护配置
- 可靠性与可观测：统一加载/空/错误状态，日志与告警

## 实施步骤
1. 登录安全改造
   - 引入安全哈希（如 `bcrypt`），替换 `app/api/auth/login/route.ts` 明文比对
   - 增加错误码与节流，避免暴力尝试
2. SSE 与聊天稳定性
   - 在 `app/chat/page.tsx` 的流解析增加心跳与断线重连
   - 在 `/api/dify/chat` 增加超时与失败重试策略
3. 助手预设与配置化
   - 将 `getPresetInputs` 抽出为配置文件，支持不同助手场景
4. 统一状态与错误展示
   - 提取 Loading/Empty/Error 组件，前后端统一响应结构
5. Supabase 权限与RLS
   - 为 `users/assistants` 开启行级安全与角色策略

## 验证与交付
- 本地跑通登录→助手→聊天完整链路
- 编写端到端检查用例（登录、拉取助手、对话历史、流式回复）
- 部署前检查 `vercel.json/.env.local` 与依赖版本，完成预演