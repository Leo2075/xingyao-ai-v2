## 目标

* 左侧助手列表支持折叠/收起，桌面与移动端一致可控。

* 发送消息后无回复时，显示等待动画的消息弹窗，并在收到流式内容或超时后自动消失。

* 历史对话记录名称支持前端内联编辑与后端更新，保持与 Dify 会话同步。

## 现状定位

* 左侧/中间侧栏与聊天区集中在 `app/chat/page.tsx`（例如：侧栏宽度控制 `app/chat/page.tsx:291-299`，消息发送流式处理 `app/chat/page.tsx:182-272`，对话列表渲染 `app/chat/page.tsx:353-377`）。

* 对话列表接口为 `app/api/dify/conversations/route.ts`（仅列举，不支持改名）。

* 消息历史接口为 `app/api/dify/messages/route.ts`。

* 消息发送为 `app/api/dify/chat/route.ts`（流式 SSE）。

## 功能一：左侧助手列表折叠/收起

* 新增状态：`leftSidebarCollapsed`（三态设计：展开 `w-64`、折叠为图标栏 `w-16`、隐藏 `w-0`）。

* UI改造：

  * 顶部操作区加入折叠/展开按钮（统一在所有断点显示，不再仅 `lg:hidden`）。

  * 折叠态仅显示助手图标；悬停显示名称的 `title` 或 Tooltip（初始用 `title`）。

  * 调整容器宽度类：`app/chat/page.tsx:291` 改为根据 `leftSidebarCollapsed` 切换 `w-64/w-16/w-0`。

  * 助手项在折叠态切换为紧凑样式（去除名称文本或隐藏 `span`）。

* 状态持久化：在 `useEffect` 读取/写入 `localStorage('chat_left_collapsed')`，页面刷新保持用户选择。

* 中控按钮：

  * 在聊天头部（`app/chat/page.tsx:382-414`）的菜单按钮改为始终可见，并支持三态切换。

## 功能二：等待动画的消息弹窗

* 新增状态：`showPendingModal`（或依据 `loading && lastAssistantEmpty` 派生），在 `sendMessage` 触发后显示。

* 弹窗样式：在消息区上方叠加固定定位的半透明遮罩与居中卡片，含旋转动画与文案（Tailwind 实现）。

* 关闭时机：

  * 当流式数据第一段 `message` 到达（`app/chat/page.tsx:240-247`）或 `finally`（`app/chat/page.tsx:269-271`）关闭。

  * 设置最长等待超时（例如 20-30s），超时自动关闭并提示重试。

* 辅助反馈：在输入框/发送按钮已有禁用态基础上，保留视觉提示。

## 功能三：历史对话记录名称可修改

* 前端交互：

  * 在每条对话项右侧加入编辑图标，点击后切换为 `input`（支持 `Enter` 保存、`Esc/Blur` 取消）。

  * 名称校验：去除首尾空格、非空、长度上限（例如 60）。

  * 乐观更新：本地先更新列表名称，失败时回滚并提示。

* 后端接口：

  * 新增 `PATCH /api/dify/conversations/[id]`：

    * 读取 `assistantId`、`userId`、`name`。

    * 转发到 Dify：`PATCH {assistant.dify_base_url}/conversations/{id}`，Header 带 `Authorization`，Body `{ name, user }`。

  * 返回更新结果，并在前端调用后刷新当前助手的对话列表（复用 `fetchConversations`）。

* 集成位置：

  * 对话项渲染处 `app/chat/page.tsx:353-377` 增加编辑 UI 与提交逻辑。

## 校验与回退

* 折叠侧栏：检查三态切换与持久化；确保在移动端与桌面端均正常。

* 等待弹窗：在网络慢或 Dify 暂不可用时出现并自动关闭；不影响已有流式显示。

* 改名：成功后列表即时更新；失败回滚并提示。

* 若 Dify 不支持改名端点，前端仍允许本地改名并在刷新时回退为服务端名称，提示“服务端暂不支持改名”。

## 验收标准

* 左侧侧栏可在展开/折叠/隐藏三态间切换，并持久化到下一次打开。

* 发送消息后在助手未回复前出现居中等待弹窗；收到首段回复或超时即自动关闭。

* 历史对话可在列表中直接改名，提交后服务端与本地一致；错误有明确提示。

